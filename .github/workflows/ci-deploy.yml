name: CI & Deploy

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:
  # ─── Job 1: Test Gate ───────────────────────────────────────────────
  test-gate:
    name: Test Gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      - name: Run CI tests (Phase 0 + Phase 1 + Component)
        run: npm run test:ci

      - name: npm audit (high/critical only)
        run: npm audit --audit-level=high

      - name: Verify ontology integrity
        run: npm run verify:ontology
        continue-on-error: true  # TODO: remove once ontology-manifest.json is created

  # ─── Job 2: Golden Tests ────────────────────────────────────────────
  golden-tests:
    name: Golden Tests
    runs-on: ubuntu-latest
    needs: test-gate
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      - name: Run golden tests
        run: npm run test:golden

      - name: Generate enhanced report
        if: always()
        run: npm run report:golden

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-results
          path: |
            tests/golden/results/latest-results.json
            tests/golden/results/enhanced-report.html
            tests/golden/results/accuracy-history.csv
          retention-days: 30

      - name: Check test status
        if: always()
        run: |
          if [ -f tests/golden/results/latest-results.json ]; then
            ACCURACY=$(node -e "const r=require('./tests/golden/results/latest-results.json'); console.log(r.summary.accuracy)")
            echo "Overall Accuracy: $ACCURACY%"
            if (( $(echo "$ACCURACY < 95" | bc -l) )); then
              echo "::warning::Golden test accuracy below 95% threshold: $ACCURACY%"
            fi
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'tests/golden/results/latest-results.json';

            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const summary = results.summary;

              const accuracyEmoji = summary.accuracy >= 95 ? '✅' : summary.accuracy >= 80 ? '⚠️' : '❌';

              const comment = `## ${accuracyEmoji} Golden Test Results

            **Overall Accuracy:** ${summary.accuracy}%
            - **Passed:** ${summary.passed}/${summary.totalTests}
            - **Failed:** ${summary.failed}
            - **Errors:** ${summary.errors}

            ### By Priority
            - **P0 (Critical):** ${summary.byPriority?.P0?.accuracy || 'N/A'}%
            - **P1 (High):** ${summary.byPriority?.P1?.accuracy || 'N/A'}%
            - **P2 (Medium):** ${summary.byPriority?.P2?.accuracy || 'N/A'}%

            [View detailed report](../actions/runs/${context.runId})
            `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # ─── Job 3: Security Tests ─────────────────────────────────────────
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: test-gate
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run security:test

  # ─── Job 4: Build & Deploy Pages ─────────────────────────────────────
  deploy-pages:
    name: Build & Deploy Pages
    runs-on: ubuntu-latest
    needs: test-gate
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      - name: Build TagTeam.js bundles
        run: |
          node scripts/build-separated.js
          node scripts/build.js

      - name: Assemble Pages site
        run: |
          mkdir -p gh-pages

          # Copy all bundles (core, values, combined)
          cp dist/tagteam.js gh-pages/
          cp dist/tagteam-core.js gh-pages/
          cp dist/tagteam-values.js gh-pages/

          # Copy landing page as index
          cp demos/tagteam-landing.html gh-pages/index.html

          # Copy Phase 6 demos
          cp demos/phase6-lattice-demo.html gh-pages/phase6-lattice-demo.html
          cp demos/phase65-ontology-demo.html gh-pages/phase65-ontology-demo.html
          cp demos/phase66-custom-tagger-demo.html gh-pages/phase66-custom-tagger-demo.html
          cp demos/stakeholder-demo.html gh-pages/stakeholder-demo.html
          cp demos/semantic-demo.html gh-pages/semantic-demo.html

          # Copy extracted demo pages
          cp demos/demo.html gh-pages/demo.html
          cp demos/separated-demo.html gh-pages/separated-demo.html

          # Copy browser validation tests
          cp dist/test.html gh-pages/test.html
          cp dist/test-week2b-full.html gh-pages/test-week2b-full.html
          cp dist/test-iee-bundle.html gh-pages/test-iee-bundle.html

          # Copy legacy validation tests
          cp tests/browser/test-week2a-context.html gh-pages/validation.html

          # Copy expert validation results
          cp tests/expert-validation/results/expert-validation-visual-summary.html gh-pages/expert-validation-visual-summary.html

          # Copy visual explainer
          cp demos/how-tagteam-works.html gh-pages/how-tagteam-works.html

          # Copy README
          cp demos/gh-pages-README.md gh-pages/README.md

      - name: Inject base tag and dev theme
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH_NAME" = "dev" ]; then
            BASE_HREF="/TagTeam.js/dev/"
            # Dark theme for dev: black background, light text, orange accent
            DEV_STYLE='<style id="dev-theme">:root{--dev-bg:#111;--dev-fg:#e0e0e0;--dev-accent:#ff9800}body{background:var(--dev-bg)!important;color:var(--dev-fg)!important}.container,div[class]{background:var(--dev-bg)!important;color:var(--dev-fg)!important;border-color:#333!important}a{color:var(--dev-accent)!important}pre,code,textarea{background:#1a1a1a!important;color:#ccc!important;border-color:#333!important}h1,h2,h3{color:var(--dev-fg)!important}button{filter:brightness(0.85)}h1::after{content:" [DEV]";color:var(--dev-accent);font-size:0.6em}</style>'
            INJECT="<base href=\"${BASE_HREF}\">${DEV_STYLE}"
          else
            BASE_HREF="/TagTeam.js/"
            INJECT="<base href=\"${BASE_HREF}\">"
          fi
          find gh-pages -name '*.html' -exec sed -i "s|<head>|<head>${INJECT}|" {} \;
          echo "Injected base href=${BASE_HREF} into all HTML files"
          [ "$BRANCH_NAME" = "dev" ] && echo "Applied dark dev theme" || true

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          destination_dir: ${{ github.ref == 'refs/heads/dev' && 'dev' || '.' }}
          keep_files: true
          enable_jekyll: false
